<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <title>Aritm Local</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <style>
    html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; background-color: #f0f2f5; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; position: fixed; width: 100%; top: 0; left: 0; user-select: none; -webkit-user-select: none; }
    body { display: flex; flex-direction: column; }
    #setup-view, #game-view, #finish-view { display: none; flex-direction: column; height: 100%; width: 100%; box-sizing: border-box; }
    
    .status-bar { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; background: white; border-bottom: 1px solid #ddd; font-weight: bold; font-size: 16px; flex-shrink: 0; height: 44px; box-sizing: border-box; }
    #btn-quit-text { color: #dc3545; cursor: pointer; }
    #count-left { color: #555; }

    .container { padding: 15px; display: flex; flex-direction: column; gap: 8px; flex-grow: 1; overflow-y: auto; }
    h2 { color: #1a73e8; text-align: center; margin: 5px 0; font-size: 20px; }
    
    .type-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .type-option { background: white; padding: 12px; border-radius: 8px; border: 1px solid #ddd; display: flex; align-items: center; font-weight: bold; font-size: 14px; cursor: pointer; }
    .type-option input { margin-right: 10px; transform: scale(1.2); }
    
    .quick-select-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; }
    .quick-btn { background: white; border: 1.5px solid #1a73e8; color: #1a73e8; padding: 8px 0; text-align: center; border-radius: 6px; font-weight: bold; font-size: 14px; cursor: pointer; border: 1.5px solid #1a73e8; }
    
    .quick-btn:focus, .adjust-btn:focus, .btn-start:focus, .type-option:focus-within {
      outline: 3px solid #ffc107;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
    }

    .adjust-container { display: flex; align-items: center; justify-content: center; background: white; padding: 5px; border-radius: 8px; border: 1px solid #ddd; }
    #total-problems { width: 60px; text-align: center; font-size: 20px; font-weight: bold; border: none; background: transparent; outline: none; }
    .adjust-btn { background: #e8f0fe; color: #1a73e8; width: 45px; height: 35px; display: flex; align-items: center; justify-content: center; border-radius: 6px; font-size: 20px; font-weight: bold; cursor: pointer; border: none; }
    
    .btn-start { background: #1a73e8; color: white; border: none; padding: 14px; border-radius: 8px; font-size: 18px; font-weight: bold; margin-top: 10px; cursor: pointer; }
    .btn-continue { background: #28a745 !important; }

    #problem-display { flex-grow: 1; display: flex; align-items: center; justify-content: center; font-size: clamp(40px, 10vh, 60px); font-weight: bold; color: #1a73e8; }
    #answer-input { width: 70%; margin: 0 auto 5px; font-size: 32px; text-align: center; padding: 5px; border: 2px solid #1a73e8; border-radius: 8px; background: white; pointer-events: none; flex-shrink: 0; color: #000; min-height: 50px; }
    
    #feedback { text-align: center; height: 24px; min-height: 24px; font-weight: bold; font-size: 18px; margin-bottom: 5px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
    .correct { color: #28a745 !important; }
    .wrong { color: #dc3545 !important; }

    .keypad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1px; background: #ccc; width: 100%; flex-shrink: 0; padding-bottom: env(safe-area-inset-bottom); }
    .key { background: white; padding: clamp(15px, 3vh, 25px) 0; font-size: 24px; font-weight: bold; text-align: center; cursor: pointer; touch-action: manipulation; }
    .key:active { background: #e0e0e0; }
    .key-0 { grid-column: span 2; }
    .key-clear { color: #dc3545; }
    .key-enter { background: #1a73e8; color: white; grid-column: span 3; font-size: 20px; padding: 15px 0; }
  </style>
</head>
<body>

  <div id="setup-view" style="display: flex;">
    <div class="container">
      <h2>Aritm Local</h2>
      <div class="type-grid">
        <label class="type-option"><input type="checkbox" value="add1" checked> Add 1</label>
        <label class="type-option"><input type="checkbox" value="add2"> Add 2</label>
        <label class="type-option"><input type="checkbox" value="sub1"> Sub 1</label>
        <label class="type-option"><input type="checkbox" value="sub2"> Sub 2</label>
        <label class="type-option"><input type="checkbox" value="mult"> Mul</label>
        <label class="type-option"><input type="checkbox" value="div"> Div</label>
      </div>
      
      <div style="margin-top: 10px;">
        <label style="font-size: 14px; font-weight: bold; color: #666;">Välj antal uppgifter:</label>
        <div class="quick-select-grid" style="margin-top: 5px;">
          <button type="button" class="quick-btn" onclick="setTotal(10)">10</button>
          <button type="button" class="quick-btn" onclick="setTotal(20)">20</button>
          <button type="button" class="quick-btn" onclick="setTotal(50)">50</button>
          <button type="button" class="quick-btn" onclick="setTotal(0)">Alla</button>
        </div>
        <div class="adjust-container" style="margin-top: 8px;">
          <button type="button" class="adjust-btn" onclick="adjustTotal(-5)">-</button>
          <input type="number" id="total-problems" value="20" readonly>
          <button type="button" class="adjust-btn" onclick="adjustTotal(5)">+</button>
        </div>
      </div>
      
      <button class="btn-start" onclick="startSession()">STARTA TRÄNING</button>
      <p style="font-size: 10px; color: #999; text-align: center; margin-top: 20px;">Baserad på Aritm Cloud (GPLv3)</p>
    </div>
  </div>

  <div id="game-view">
    <div class="status-bar">
      <span id="btn-quit-text" onclick="quitGame()">&nbsp;&nbsp;&nbsp;Avbryt (Esc)</span>
      <span id="count-left">Kvar: -&nbsp;&nbsp;&nbsp;</span>
    </div>
    <div id="problem-display"><span id="problem-text">Laddar...</span></div>
    <input type="text" id="answer-input" readonly placeholder="?">
    <div id="feedback"></div>
    <div class="keypad">
      <div class="key" onclick="pressKey('7')">7</div><div class="key" onclick="pressKey('8')">8</div><div class="key" onclick="pressKey('9')">9</div>
      <div class="key" onclick="pressKey('4')">4</div><div class="key" onclick="pressKey('5')">5</div><div class="key" onclick="pressKey('6')">6</div>
      <div class="key" onclick="pressKey('1')">1</div><div class="key" onclick="pressKey('2')">2</div><div class="key" onclick="pressKey('3')">3</div>
      <div class="key key-0" onclick="pressKey('0')">0</div><div class="key key-clear" onclick="pressKey('C')">C</div>
      <div class="key key-enter" onclick="submitAnswer()">SVAR</div>
    </div>
  </div>

  <div id="finish-view">
    <div class="container" style="text-align: center; justify-content: center;">
      <h2 id="finish-title">Bra jobbat!</h2>
      <p id="final-score" style="font-size: 18px; color: #555;"></p>
      <button id="btn-continue" class="btn-start btn-continue" style="display: none;" onclick="continueSession()">FORTSÄTT</button>
      <button class="btn-start" onclick="restartApp()">NY ÖVNING</button>
    </div>
  </div>

  <script>
    let problemPool = [];
    let currentProblemStr = null;
    let isProcessing = false;
    const SAVE_KEY = 'aritm_local_save_v1';
    const SETTINGS_KEY = 'aritm_local_settings';

    // Nytt syntetiskt ljud för offline-läge
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playErrorSound() {
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.connect(gain);
      gain.connect(audioCtx.destination);
      osc.type = 'sawtooth'; 
      osc.frequency.setValueAtTime(150, audioCtx.currentTime); 
      gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
      osc.start();
      osc.stop(audioCtx.currentTime + 0.3);
    }

    document.addEventListener('keydown', function(event) {
      const key = event.key;
      const isGameView = document.getElementById('game-view').style.display === 'flex';
      const isSetupView = document.getElementById('setup-view').style.display === 'flex';
      if (isGameView) {
        if (isProcessing) return;
        if (key >= '0' && key <= '9') pressKey(key);
        else if (key === 'Enter' || key === ' ') { event.preventDefault(); submitAnswer(); }
        else if (key === 'Backspace' || key === 'Delete') { event.preventDefault(); pressKey('C'); }
        else if (key === 'Escape') { event.preventDefault(); quitGame(); }
      } else if (isSetupView) {
        if (key === '+' || key === '=') { event.preventDefault(); adjustTotal(5); }
        else if (key === '-') { event.preventDefault(); adjustTotal(-5); }
      }
    });

    function saveSettings() {
      const types = Array.from(document.querySelectorAll('.type-option input')).map(i => ({ val: i.value, checked: i.checked }));
      const total = document.getElementById('total-problems').value;
      localStorage.setItem(SETTINGS_KEY, JSON.stringify({ types, total }));
    }

    function loadSettings() {
      const saved = localStorage.getItem(SETTINGS_KEY);
      if (saved) {
        try {
          const { types, total } = JSON.parse(saved);
          document.getElementById('total-problems').value = total;
          types.forEach(t => {
            const input = document.querySelector(`.type-option input[value="${t.val}"]`);
            if (input) input.checked = t.checked;
          });
        } catch(e) {}
      }
    }

    function computeAnswer(str) {
      let expression = str.replace('⋅', '*');
      return Math.floor(eval(expression));
    }

    function createPool(types) {
      let pool = [];
      types.forEach(type => {
        if (type === 'add1') { for (let i=0; i<=9; i++) for (let j=0; j<=9; j++) pool.push(`${i} + ${j}`); }
        else if (type === 'add2') { for (let i=0; i<=9; i++) for (let j=0; j<=9; j++) { let t = 10 * (Math.floor(Math.random() * 8) + 1); pool.push(`${t+i} + ${j}`); } }
        else if (type === 'sub1') { for (let i=0; i<=9; i++) for (let j=0; j<=9; j++) pool.push(`${i+j} - ${j}`); }
        else if (type === 'sub2') { for (let i=0; i<=9; i++) for (let j=0; j<=9; j++) { let t = 10 * (Math.floor(Math.random() * 9) + 1); pool.push(`${t+i+j} - ${j}`); } }
        else if (type === 'mult') { for (let i=0; i<=9; i++) for (let j=0; j<=9; j++) pool.push(`${i} ⋅ ${j}`); }
        else if (type === 'div') { for (let i = 0; i <= 9; i++) for (let j = 1; j <= 9; j++) { pool.push(`${i * j + Math.floor(j * Math.random())} / ${j}`); } }
      });
      shuffle(pool);
      return pool;
    }

    window.onload = function() {
      loadSettings();
      const savedData = localStorage.getItem(SAVE_KEY);
      if (savedData) {
        try {
          const state = JSON.parse(savedData);
          if (state && state.pool && state.current) {
            problemPool = state.pool;
            currentProblemStr = state.current;
            showView('game-view');
            updateUI();
            return;
          }
        } catch(e) {}
      }
      showView('setup-view');
    };

    function saveProgress() { localStorage.setItem(SAVE_KEY, JSON.stringify({ pool: problemPool, current: currentProblemStr })); }
    function shuffle(array) { for (let i = array.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [array[i], array[j]] = [array[j], array[i]]; } }

    function startSession() {
      saveSettings();
      const types = Array.from(document.querySelectorAll('.type-option input:checked')).map(e => e.value);
      if (types.length === 0) return;
      problemPool = createPool(types);
      let requestedTotal = parseInt(document.getElementById('total-problems').value);
      if (requestedTotal > 0 && requestedTotal < problemPool.length) { problemPool = problemPool.slice(0, requestedTotal); }
      nextProblem(); 
      showView('game-view');
    }

    function continueSession() { showView('game-view'); updateUI(); }
    function nextProblem() { if (problemPool.length === 0) { finishGame(); return; } currentProblemStr = problemPool.shift(); saveProgress(); updateUI(); }

    function submitAnswer() {
      if (isProcessing || !currentProblemStr) return;
      const input = document.getElementById('answer-input').value;
      if (input === "") return;
      isProcessing = true;
      const expected = computeAnswer(currentProblemStr);
      const f = document.getElementById('feedback');
      if (parseInt(input) === expected) {
        f.innerText = "Rätt!"; f.className = "correct";
        setTimeout(() => { f.innerText = ""; f.className = ""; isProcessing = false; nextProblem(); }, 400);
      } else {
        f.innerText = "Fel! Försök igen."; f.className = "wrong";
        problemPool.push(currentProblemStr);
        saveProgress();
        playErrorSound(); // Spelar det lokala ljudet
        document.getElementById('answer-input').value = "";
        document.getElementById('count-left').innerHTML = "Kvar: " + (problemPool.length + 1) + "&nbsp;&nbsp;&nbsp;";
        isProcessing = false;
      }
    }

    function updateUI() {
      if (!currentProblemStr) return;
      document.getElementById('problem-text').innerText = currentProblemStr;
      document.getElementById('count-left').innerHTML = "Kvar: " + (problemPool.length + 1) + "&nbsp;&nbsp;&nbsp;";
      document.getElementById('answer-input').value = "";
    }

    function finishGame() { localStorage.removeItem(SAVE_KEY); document.getElementById('btn-continue').style.display = 'none'; showView('finish-view'); document.getElementById('final-score').innerText = "Du har klarat alla uppgifter!"; document.getElementById('finish-title').innerText = "Bra jobbat!"; }
    function quitGame() { document.getElementById('btn-continue').style.display = 'block'; showView('finish-view'); document.getElementById('finish-title').innerText = "Avbruten"; document.getElementById('final-score').innerText = "Du hade " + (problemPool.length + (currentProblemStr ? 1 : 0)) + " kvar."; }
    function restartApp() { localStorage.removeItem(SAVE_KEY); showView('setup-view'); }
    function showView(v) { ['setup-view', 'game-view', 'finish-view'].forEach(id => document.getElementById(id).style.display = 'none'); document.getElementById(v).style.display = 'flex'; }
    function setTotal(n) { document.getElementById('total-problems').value = n; }
    function adjustTotal(d) { let v = parseInt(document.getElementById('total-problems').value) || 0; document.getElementById('total-problems').value = Math.max(0, v + d); }
    function pressKey(n) { if (isProcessing) return; const i = document.getElementById('answer-input'); if (n === 'C') i.value = ""; else if (i.value.length < 5) i.value += n; }
  </script>
</body>
</html>
