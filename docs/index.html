<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <title>Aritm Cloud</title> 
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="color-scheme" content="light dark">
  <style>
    :root { --bg: #f0f2f5; --container-bg: #ffffff; --text: #333333; --accent: #1a73e8; --border: #dddddd; }
    @media (prefers-color-scheme: dark) { :root { --bg: #121212; --container-bg: #1e1e1e; --text: #e0e0e0; --accent: #4dabf7; --border: #333333; } }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
    body { margin: 0; font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); overflow: hidden; height: 100vh; }
    .container { padding: 15px; display: flex; flex-direction: column; gap: 10px; height: 100%; overflow-y: auto; }
    #setup-view, #game-view, #finish-view, #quit-confirm-view { display: none; flex-direction: column; height: 100%; }
    .type-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .type-option { background: var(--container-bg); padding: 15px; border-radius: 10px; border: 1px solid var(--border); display: flex; align-items: center; cursor: pointer; font-weight: bold; }
    .type-option input { margin-right: 12px; transform: scale(1.3); }
    .adjust-container { display: flex; align-items: center; justify-content: center; gap: 15px; margin: 10px 0; }
    .adjust-btn { background: var(--accent); color: white; border: none; width: 50px; height: 40px; border-radius: 8px; font-size: 24px; }
    #total-problems { width: 80px; text-align: center; font-size: 24px; background: transparent; color: var(--text); border: none; font-weight: bold; }
    .btn-start { background: var(--accent); color: white; border: none; padding: 18px; border-radius: 10px; font-size: 20px; font-weight: bold; cursor: pointer; }
    #problem-display { flex-grow: 1; display: flex; align-items: center; justify-content: center; font-size: 60px; font-weight: bold; color: var(--accent); }
    #answer-input { width: 80%; margin: 0 auto 15px; font-size: 35px; text-align: center; padding: 10px; border: 2px solid var(--accent); border-radius: 10px; background: var(--container-bg); color: var(--text); }
    .keypad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1px; background: var(--border); }
    .key { background: var(--container-bg); padding: 20px; text-align: center; font-size: 28px; font-weight: bold; cursor: pointer; }
    .key-enter { background: var(--accent); color: white; grid-column: span 3; }
    .status-bar { display: flex; justify-content: space-between; padding: 10px; font-weight: bold; border-bottom: 1px solid var(--border); }
  </style>
</head>
<body data-current-view="setup-view">

  <div id="setup-view" style="display: flex;">
    <div class="container">
      <h1 style="text-align:center;">Aritm Cloud</h1>
      <div class="type-grid" id="type-options">
        <label class="type-option"><input type="checkbox" value="add1" checked> Add 1</label>
        <label class="type-option"><input type="checkbox" value="add2"> Add 2</label>
        <label class="type-option"><input type="checkbox" value="sub1"> Sub 1</label>
        <label class="type-option"><input type="checkbox" value="sub2"> Sub 2</label>
        <label class="type-option"><input type="checkbox" value="mul"> Mul</label>
        <label class="type-option"><input type="checkbox" value="div"> Div</label>
      </div>
      <div class="adjust-container">
        <button class="adjust-btn" onclick="adjustTotal(-5)">-</button>
        <input type="number" id="total-problems" value="20" readonly>
        <button class="adjust-btn" onclick="adjustTotal(5)">+</button>
      </div>
      <button class="btn-start" onclick="startSession()">STARTA TRÄNING</button>
    </div>
  </div>

  <div id="game-view">
    <div class="status-bar">
      <span style="color:#dc3545;" onclick="confirmQuit()">Avbryt</span>
      <span id="count-left"></span>
    </div>
    <div id="problem-display"><span id="problem-text"></span></div>
    <input type="text" id="answer-input" readonly>
    <div id="feedback" style="text-align:center; height:25px; font-weight:bold;"></div>
    <div class="keypad">
      <div class="key" onclick="pressKey('7')">7</div><div class="key" onclick="pressKey('8')">8</div><div class="key" onclick="pressKey('9')">9</div>
      <div class="key" onclick="pressKey('4')">4</div><div class="key" onclick="pressKey('5')">5</div><div class="key" onclick="pressKey('6')">6</div>
      <div class="key" onclick="pressKey('1')">1</div><div class="key" onclick="pressKey('2')">2</div><div class="key" onclick="pressKey('3')">3</div>
      <div class="key" style="grid-column: span 2;" onclick="pressKey('0')">0</div><div class="key" style="color:#dc3545;" onclick="pressKey('C')">C</div>
      <div class="key key-enter" onclick="submitAnswer()">SVAR</div>
    </div>
  </div>

  <script>
    // Storage-objektet är nu "icke-blockerande"
    const Storage = {
      isCloud: () => (typeof google !== 'undefined' && google.script && google.script.run),
      
      saveSettings: (s) => {
        const str = JSON.stringify(s);
        localStorage.setItem('aritm_settings', str);
        if (Storage.isCloud()) google.script.run.saveSettings(str);
      },
      
      saveProgress: (p) => {
        const str = JSON.stringify(p);
        localStorage.setItem('aritm_save', str);
        if (Storage.isCloud() && str.length < 8000) {
          google.script.run.saveState(str);
        }
      },
      
      clearProgress: () => {
        localStorage.removeItem('aritm_save');
        if (Storage.isCloud()) google.script.run.clearState();
      }
    };

    let problemPool = [], currentProblemStr = null, isProcessing = false;
    let startTime = 0, initialTotal = 0;

    function showView(v) {
      document.body.setAttribute('data-current-view', v);
      ['setup-view', 'game-view'].forEach(id => {
        document.getElementById(id).style.display = (id === v) ? 'flex' : 'none';
      });
    }

    function createPool(types) {
      let pool = [];
      // Samma logik som i din fungerande version
      if (types.includes('add1')) for(let i=0;i<10;i++) for(let j=0;j<10;j++) pool.push(`${i} + ${j}`);
      if (types.includes('mul')) for(let i=0;i<10;i++) for(let j=0;j<10;j++) pool.push(`${i} ⋅ ${j}`);
      // ... (övriga typer)
      return pool.sort(() => Math.random() - 0.5);
    }

    function startSession() {
      const selected = Array.from(document.querySelectorAll('#type-options input:checked')).map(i => i.value);
      const total = parseInt(document.getElementById('total-problems').value);
      
      // Spara inställningar (molnet uppdateras i bakgrunden)
      Storage.saveSettings({total: total, types: selected});
      
      problemPool = createPool(selected);
      if (total > 0) problemPool = problemPool.slice(0, total);
      
      startTime = Date.now();
      initialTotal = problemPool.length;
      
      showView('game-view');
      nextProblem();
    }

    function nextProblem() {
      if (!problemPool.length) {
        alert("Klar!");
        Storage.clearProgress();
        showView('setup-view');
        return;
      }
      currentProblemStr = problemPool.shift();
      document.getElementById('problem-text').innerText = currentProblemStr;
      document.getElementById('count-left').innerText = "Kvar: " + (problemPool.length + 1);
      document.getElementById('answer-input').value = "";
      Storage.saveProgress({pool: problemPool, current: currentProblemStr, startTime, initialTotal});
    }

    function submitAnswer() {
      const val = document.getElementById('answer-input').value;
      const expected = eval(currentProblemStr.replace('⋅', '*'));
      if (parseInt(val) === expected) {
        nextProblem();
      } else {
        document.getElementById('feedback').innerText = "Fel!";
        setTimeout(() => document.getElementById('feedback').innerText = "", 1000);
        problemPool.push(currentProblemStr);
        nextProblem();
      }
    }

    function pressKey(n) {
      const inp = document.getElementById('answer-input');
      if (n === 'C') inp.value = ""; else inp.value += n;
    }

    function adjustTotal(n) {
      const el = document.getElementById('total-problems');
      el.value = Math.max(0, parseInt(el.value) + n);
    }

    window.onload = () => {
      // 1. Ladda från localStorage direkt för snabb start
      const s = JSON.parse(localStorage.getItem('aritm_settings'));
      if (s) {
        document.getElementById('total-problems').value = s.total;
        // Markera checkboxes...
      }

      // 2. Om vi är i molnet, hämta färska inställningar i bakgrunden
      if (Storage.isCloud()) {
        google.script.run.withSuccessHandler(res => {
          if (res) {
            const cloudS = JSON.parse(res);
            document.getElementById('total-problems').value = cloudS.total;
          }
        }).loadSettings();
      }
    };
  </script>
</body>
</html>
