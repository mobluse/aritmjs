<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <title>Aritm Local</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="color-scheme" content="light dark">
  <link rel="manifest" href="manifest.json">
  <style>
    :root {
      --bg: #f0f2f5; --container-bg: #ffffff; --text: #333333;
      --accent: #1a73e8; --border: #dddddd; --status-bg: #ffffff;
      --key-bg: #ffffff; --key-text: #000000; --input-bg: #ffffff;
    }
    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #121212; --container-bg: #1e1e1e; --text: #e0e0e0;
        --accent: #4dabf7; --border: #333333; --status-bg: #1e1e1e;
        --key-bg: #2d2d2d; --key-text: #ffffff; --input-bg: #2d2d2d;
      }
    }
    * { -webkit-tap-highlight-color: transparent; user-select: none; box-sizing: border-box; }
    html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; background-color: var(--bg); color: var(--text); font-family: -apple-system, sans-serif; position: fixed; width: 100%; }
    
    /* Android TV / Keyboard Focus Styles */
    :focus { outline: 3px solid var(--accent); outline-offset: 2px; }
    
    #setup-view, #game-view, #finish-view, #quit-confirm-view { display: none; flex-direction: column; height: 100%; width: 100%; }
    .container { padding: 10px; display: flex; flex-direction: column; gap: 6px; flex-grow: 1; overflow-y: auto; }
    
    .status-bar { display: flex; justify-content: space-between; align-items: center; padding: 0 10px; background: var(--status-bg); border-bottom: 1px solid var(--border); height: 35px; flex-shrink: 0; font-weight: bold; }
    #btn-quit-text { color: #dc3545; cursor: pointer; padding: 5px; }

    .type-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; }
    .type-option { background: var(--container-bg); padding: 12px; border-radius: 8px; border: 1px solid var(--border); display: flex; align-items: center; font-weight: bold; cursor: pointer; }
    .type-option input { margin-right: 10px; transform: scale(1.2); }

    .quick-select-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; }
    .quick-btn { background: var(--container-bg); border: 1.5px solid var(--accent); color: var(--accent); padding: 8px 0; border-radius: 6px; font-weight: bold; cursor: pointer; }
    
    .adjust-container { display: flex; align-items: center; justify-content: center; background: var(--container-bg); border-radius: 8px; border: 1px solid var(--border); padding: 4px; }
    #total-problems { width: 60px; text-align: center; font-size: 20px; border: none; background: transparent; color: var(--text); font-weight: bold; }
    .adjust-btn { background: var(--accent); color: white; width: 45px; height: 35px; border-radius: 6px; font-size: 20px; border: none; cursor: pointer; }

    #problem-display { flex-grow: 1; display: flex; align-items: center; justify-content: center; font-size: clamp(40px, 10vh, 70px); font-weight: bold; color: var(--accent); }
    #answer-input { width: 80%; margin: 0 auto 10px; font-size: 32px; text-align: center; padding: 8px; border: 2px solid var(--accent); border-radius: 8px; background: var(--input-bg); color: var(--text); min-height: 55px; }
    #feedback { text-align: center; min-height: 30px; font-weight: bold; font-size: 20px; }
    .correct { color: #28a745; } .wrong { color: #dc3545; }

    .keypad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1px; background: var(--border); padding-bottom: env(safe-area-inset-bottom); }
    .key { background: var(--key-bg); color: var(--key-text); padding: 20px 0; font-size: 26px; font-weight: bold; text-align: center; cursor: pointer; touch-action: manipulation; }
    .key:active { background: var(--bg); }
    .key-0 { grid-column: span 2; } .key-clear { color: #dc3545; } .key-enter { background: var(--accent); color: white; grid-column: span 3; }
    
    .btn-start { background: var(--accent); color: white; border: none; padding: 15px; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; width: 100%; margin-top: 10px; }
    .btn-secondary { background: var(--border); color: var(--text); border: none; padding: 15px; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; width: 100%; margin-top: 10px; }
  </style>
</head>
<body data-current-view="setup-view">

  <div id="setup-view" style="display: flex;">
    <div class="container">
      <h2 style="text-align:center; color:var(--accent);">Aritm</h2>
      <div class="type-grid">
        <label class="type-option" tabindex="0"><input type="checkbox" value="add1" checked> Add 1</label>
        <label class="type-option" tabindex="0"><input type="checkbox" value="add2"> Add 2</label>
        <label class="type-option" tabindex="0"><input type="checkbox" value="sub1"> Sub 1</label>
        <label class="type-option" tabindex="0"><input type="checkbox" value="sub2"> Sub 2</label>
        <label class="type-option" tabindex="0"><input type="checkbox" value="mul"> Mul</label>
        <label class="type-option" tabindex="0"><input type="checkbox" value="div"> Div</label>
      </div>
      <div class="quick-select-grid" style="margin-top:10px;">
        <button class="quick-btn" onclick="setTotal(10)">10</button>
        <button class="quick-btn" onclick="setTotal(20)">20</button>
        <button class="quick-btn" onclick="setTotal(50)">50</button>
        <button class="quick-btn" onclick="setTotal(0)">Alla</button>
      </div>
      <div class="adjust-container">
        <button class="adjust-btn" onclick="adjustTotal(-5)" aria-label="Minska">-</button>
        <input type="number" id="total-problems" value="20" readonly>
        <button class="adjust-btn" onclick="adjustTotal(5)" aria-label="Öka">+</button>
      </div>
      <button class="btn-start" onclick="startSession()">STARTA TRÄNING</button>
    </div>
  </div>

  <div id="game-view">
    <div class="status-bar">
      <span id="btn-quit-text" onclick="confirmQuit()" tabindex="0">Avbryt (Esc)</span>
      <span id="count-left"></span>
    </div>
    <div id="problem-display"><span id="problem-text"></span></div>
    <input type="text" id="answer-input" readonly placeholder="?">
    <div id="feedback"></div>
    <div class="keypad">
      <div class="key" tabindex="0" onclick="pressKey('7')">7</div><div class="key" tabindex="0" onclick="pressKey('8')">8</div><div class="key" tabindex="0" onclick="pressKey('9')">9</div>
      <div class="key" tabindex="0" onclick="pressKey('4')">4</div><div class="key" tabindex="0" onclick="pressKey('5')">5</div><div class="key" tabindex="0" onclick="pressKey('6')">6</div>
      <div class="key" tabindex="0" onclick="pressKey('1')">1</div><div class="key" tabindex="0" onclick="pressKey('2')">2</div><div class="key" tabindex="0" onclick="pressKey('3')">3</div>
      <div class="key key-0" tabindex="0" onclick="pressKey('0')">0</div><div class="key key-clear" tabindex="0" onclick="pressKey('C')">C</div>
      <div class="key key-enter" tabindex="0" onclick="submitAnswer()">SVAR</div>
    </div>
  </div>

  <div id="quit-confirm-view">
    <div class="container" style="text-align:center; justify-content:center;">
      <h2>Avbryta?</h2>
      <button class="btn-start" style="background:#dc3545;" onclick="quitGame()" tabindex="0">JA, AVSLUTA</button>
      <button class="btn-secondary" onclick="resumeGame()" tabindex="0">NEJ, FORTSÄTT</button>
    </div>
  </div>

  <div id="finish-view">
    <div class="container" style="text-align:center; justify-content:center;">
      <h2 id="finish-title">Klar!</h2>
      <p id="final-score"></p>
      <p id="speed-stats"></p>
      <button class="btn-start" onclick="restartApp()" tabindex="0">NY ÖVNING</button>
    </div>
  </div>

  <script>
    const Storage = {
      saveSettings: (s) => localStorage.setItem('aritm_settings', JSON.stringify(s)),
      loadSettings: () => JSON.parse(localStorage.getItem('aritm_settings')),
      saveProgress: (p) => localStorage.setItem('aritm_save', JSON.stringify(p)),
      loadProgress: () => JSON.parse(localStorage.getItem('aritm_save')),
      clearProgress: () => localStorage.removeItem('aritm_save')
    };

    let problemPool = [], currentProblemStr = null, isProcessing = false;
    let startTime = 0, initialTotal = 0;
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

    function playError() {
      try {
        const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
        o.connect(g); g.connect(audioCtx.destination); o.type = 'sawtooth';
        o.frequency.setValueAtTime(150, audioCtx.currentTime); g.gain.setValueAtTime(0.05, audioCtx.currentTime);
        o.start(); o.stop(audioCtx.currentTime + 0.2);
      } catch(e) {}
    }

    function showView(v) {
      document.body.setAttribute('data-current-view', v);
      ['setup-view', 'game-view', 'finish-view', 'quit-confirm-view'].forEach(id => {
        document.getElementById(id).style.display = (id === v) ? 'flex' : 'none';
      });
      // Sätt fokus på huvudknappen i den nya vyn för TV-navigering
      const firstBtn = document.getElementById(v).querySelector('button, [tabindex="0"]');
      if (firstBtn) firstBtn.focus();
    }

    function createPool(types) {
      let pool = [];
      types.forEach(t => {
        if (t === 'add1') { for(let i=0;i<10;i++) for(let j=0;j<10;j++) pool.push(`${i} + ${j}`); }
        else if (t === 'add2') { for(let i=0;i<100;i++) pool.push(`${10*(Math.floor(Math.random()*8)+1)+(i%10)} + ${Math.floor(i/10)}`); }
        else if (t === 'sub1') { for(let i=0;i<10;i++) for(let j=0;j<10;j++) pool.push(`${i+j} - ${j}`); }
        else if (t === 'sub2') { for(let i=0;i<100;i++) { let b=Math.floor(i/10); pool.push(`${10*(Math.floor(Math.random()*9)+1)+(i%10)+b} - ${b}`); } }
        else if (t === 'mul') { for(let i=0;i<10;i++) for(let j=0;j<10;j++) pool.push(`${i} ⋅ ${j}`); }
        else if (t === 'div') { for(let i=0;i<10;i++) for(let j=1;j<10;j++) pool.push(`${i*j+Math.floor(j*Math.random())} / ${j}`); }
      });
      for (let i=pool.length-1; i>0; i--) { const j=Math.floor(Math.random()*(i+1)); [pool[i],pool[j]]=[pool[j],pool[i]]; }
      return pool;
    }

    function startSession() {
      const selected = Array.from(document.querySelectorAll('.type-option input:checked')).map(i => i.value);
      if (!selected.length) return;
      const totalVal = parseInt(document.getElementById('total-problems').value);
      Storage.saveSettings({total: totalVal, types: Array.from(document.querySelectorAll('.type-option input')).map(i => ({val: i.value, checked: i.checked}))});
      problemPool = createPool(selected);
      if (totalVal > 0 && totalVal < problemPool.length) problemPool = problemPool.slice(0, totalVal);
      startTime = Date.now(); initialTotal = problemPool.length;
      nextProblem(); showView('game-view');
    }

    function nextProblem() {
      document.getElementById('feedback').innerText = "";
      if (!problemPool.length) {
        Storage.clearProgress();
        const min = (Date.now() - startTime) / 60000;
        document.getElementById('final-score').innerText = "Klar!";
        document.getElementById('speed-stats').innerText = min > 0 ? (initialTotal/min).toFixed(1).replace('.',',') + " uppgifter/min" : "";
        showView('finish-view'); return;
      }
      currentProblemStr = problemPool.shift();
      Storage.saveProgress({pool: problemPool, current: currentProblemStr, startTime, initialTotal});
      document.getElementById('problem-text').innerText = currentProblemStr;
      document.getElementById('count-left').innerText = "Kvar: " + (problemPool.length + 1);
      document.getElementById('answer-input').value = "";
    }

    function submitAnswer() {
      if (isProcessing) return;
      const val = document.getElementById('answer-input').value;
      if (!val) return;
      const expected = Math.floor(eval(currentProblemStr.replace('⋅', '*')));
      const f = document.getElementById('feedback');
      if (parseInt(val) === expected) {
        isProcessing = true; f.innerText = "Rätt!"; f.className = "correct";
        setTimeout(() => { isProcessing = false; nextProblem(); }, 400);
      } else {
        f.innerText = `Fel! ${currentProblemStr} = ${expected}`; f.className = "wrong";
        playError(); problemPool.push(currentProblemStr);
        Storage.saveProgress({pool: problemPool, current: currentProblemStr, startTime, initialTotal});
        document.getElementById('answer-input').value = "";
      }
    }

    function confirmQuit() { showView('quit-confirm-view'); }
    function resumeGame() { showView('game-view'); }
    function quitGame() { Storage.clearProgress(); showView('setup-view'); }
    function restartApp() { showView('setup-view'); }
    function setTotal(n) { document.getElementById('total-problems').value = n; }
    function adjustTotal(d) { let v = parseInt(document.getElementById('total-problems').value)||0; setTotal(Math.max(0,v+d)); }
    
    function pressKey(n) { 
      if (isProcessing) return;
      const inp = document.getElementById('answer-input');
      if(n==='C') inp.value = ""; 
      else if(inp.value.length < 5) inp.value += n; 
    }

    // Tangentbords- och TV-stöd
    window.addEventListener('keydown', (e) => {
      const view = document.body.getAttribute('data-current-view');
      
      // Mellanslag eller Enter för att skicka svar
      if (e.key === ' ' || e.key === 'Enter') {
        if (view === 'game-view') {
           e.preventDefault();
           submitAnswer();
        } else if (document.activeElement && document.activeElement.click) {
           // På TV/Setup: klicka på den fokuserade knappen
           document.activeElement.click();
        }
        return;
      }

      if (e.key === 'Escape') {
        if (view === 'game-view') confirmQuit();
        else if (view === 'quit-confirm-view') resumeGame();
        return;
      }

      if (view !== 'game-view' || isProcessing) return;
      if (e.key >= '0' && e.key <= '9') pressKey(e.key);
      else if (e.key === 'Backspace' || e.key === 'c' || e.key === 'C') pressKey('C');
    });

    window.onload = () => {
      const s = Storage.loadSettings();
      if (s) {
        setTotal(s.total);
        if (s.types) s.types.forEach(t => { const el = document.querySelector(`input[value="${t.val}"]`); if(el) el.checked = t.checked; });
      }
      const p = Storage.loadProgress();
      if (p) {
        problemPool = p.pool; currentProblemStr = p.current; startTime = p.startTime; initialTotal = p.initialTotal;
        document.getElementById('problem-text').innerText = currentProblemStr;
        document.getElementById('count-left').innerText = "Kvar: " + (problemPool.length + 1);
        showView('game-view');
      }
    };
    
    // Registrera Service Worker för offline-stöd (PWA)
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
          .then(reg => console.log('Service Worker registrerad!'))
          .catch(err => console.error('SW-fel:', err));
      });
    }
  </script>
</body>
</html>
