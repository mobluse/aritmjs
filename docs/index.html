<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <title>Aritm Hybrid</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <style>
    /* CSS förblir identisk för att behålla utseendet */
    html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; background-color: #f0f2f5; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; position: fixed; width: 100%; top: 0; left: 0; user-select: none; -webkit-user-select: none; }
    body { display: flex; flex-direction: column; }
    #setup-view, #game-view, #finish-view { display: none; flex-direction: column; height: 100%; width: 100%; box-sizing: border-box; }
    .status-bar { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; background: white; border-bottom: 1px solid #ddd; font-weight: bold; font-size: 16px; height: 44px; flex-shrink: 0; }
    #btn-quit-text { color: #dc3545; cursor: pointer; }
    .container { padding: 15px; display: flex; flex-direction: column; gap: 8px; flex-grow: 1; overflow-y: auto; }
    h2 { color: #1a73e8; text-align: center; margin: 5px 0; font-size: 20px; }
    .type-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .type-option { background: white; padding: 12px; border-radius: 8px; border: 1px solid #ddd; display: flex; align-items: center; font-weight: bold; font-size: 14px; cursor: pointer; }
    .type-option input { margin-right: 10px; transform: scale(1.2); }
    .quick-btn { background: white; border: 1.5px solid #1a73e8; color: #1a73e8; padding: 8px 0; text-align: center; border-radius: 6px; font-weight: bold; cursor: pointer; }
    .btn-start { background: #1a73e8; color: white; border: none; padding: 14px; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; }
    .btn-continue { background: #28a745 !important; margin-bottom: 10px; }
    #problem-display { flex-grow: 1; display: flex; align-items: center; justify-content: center; font-size: 60px; font-weight: bold; color: #1a73e8; }
    #answer-input { width: 70%; margin: 0 auto 5px; font-size: 32px; text-align: center; padding: 5px; border: 2px solid #1a73e8; border-radius: 8px; background: white; pointer-events: none; }
    #feedback { text-align: center; height: 24px; font-weight: bold; margin-bottom: 5px; }
    .correct { color: #28a745; } .wrong { color: #dc3545; }
    .keypad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1px; background: #ccc; width: 100%; }
    .key { background: white; padding: 25px 0; font-size: 24px; font-weight: bold; text-align: center; cursor: pointer; }
    .key-0 { grid-column: span 2; } .key-enter { background: #1a73e8; color: white; grid-column: span 3; }
  </style>
</head>
<body>

  <div id="setup-view" style="display: flex;">
    <div class="container">
      <h2 id="app-title">Aritm</h2>
      <div class="type-grid">
        <label class="type-option"><input type="checkbox" value="add1" checked> Add 1</label>
        <label class="type-option"><input type="checkbox" value="add2"> Add 2</label>
        <label class="type-option"><input type="checkbox" value="sub1"> Sub 1</label>
        <label class="type-option"><input type="checkbox" value="sub2"> Sub 2</label>
        <label class="type-option"><input type="checkbox" value="mult"> Mul</label>
        <label class="type-option"><input type="checkbox" value="div"> Div</label>
      </div>
      <input type="number" id="total-problems" value="20" style="text-align:center; font-size:20px;" readonly>
      <button class="btn-start" onclick="startSession()">STARTA</button>
    </div>
  </div>

  <div id="game-view">
    <div class="status-bar">
      <span id="btn-quit-text" onclick="quitGame()">Avbryt</span>
      <span id="count-left">Kvar: -</span>
    </div>
    <div id="problem-display"><span id="problem-text"></span></div>
    <input type="text" id="answer-input" readonly placeholder="?">
    <div id="feedback"></div>
    <div class="keypad">
      <div class="key" onclick="pressKey('7')">7</div><div class="key" onclick="pressKey('8')">8</div><div class="key" onclick="pressKey('9')">9</div>
      <div class="key" onclick="pressKey('4')">4</div><div class="key" onclick="pressKey('5')">5</div><div class="key" onclick="pressKey('6')">6</div>
      <div class="key" onclick="pressKey('1')">1</div><div class="key" onclick="pressKey('2')">2</div><div class="key" onclick="pressKey('3')">3</div>
      <div class="key key-0" onclick="pressKey('0')">0</div><div class="key" onclick="pressKey('C')">C</div>
      <div class="key key-enter" onclick="submitAnswer()">SVAR</div>
    </div>
  </div>

  <div id="finish-view">
    <div class="container" style="text-align: center; justify-content: center;">
      <h2 id="finish-title">Klar!</h2>
      <p id="final-score"></p>
      <button id="btn-continue" class="btn-start btn-continue" style="display:none;" onclick="showView('game-view')">FORTSÄTT</button>
      <button class="btn-start" onclick="restartApp()">NY ÖVNING</button>
    </div>
  </div>

  <script>
    // --- SMART STORAGE ADAPTER ---
    const isCloud = (typeof google !== 'undefined' && google.script);
    const Storage = {
      saveSettings: (s) => isCloud ? google.script.run.saveCloudSettings(JSON.stringify(s)) : localStorage.setItem('settings', JSON.stringify(s)),
      loadSettings: (cb) => isCloud ? google.script.run.withSuccessHandler(res => cb(JSON.parse(res))).loadCloudSettings() : cb(JSON.parse(localStorage.getItem('settings'))),
      saveProgress: (p) => isCloud ? google.script.run.saveCloudProgress(JSON.stringify(p)) : localStorage.setItem('progress', JSON.stringify(p)),
      loadProgress: (cb) => isCloud ? google.script.run.withSuccessHandler(res => cb(JSON.parse(res))).loadCloudProgress() : cb(JSON.parse(localStorage.getItem('progress'))),
      clearProgress: () => isCloud ? google.script.run.clearCloudProgress() : localStorage.removeItem('progress')
    };

    let problemPool = [], currentProblemStr = null, isProcessing = false;

    // Syntetiskt ljud (Offline-säkert)
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playError() {
      const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
      o.connect(g); g.connect(audioCtx.destination); o.type = 'sawtooth';
      o.frequency.setValueAtTime(150, audioCtx.currentTime); g.gain.setValueAtTime(0.1, audioCtx.currentTime);
      o.start(); o.stop(audioCtx.currentTime + 0.2);
    }

    window.onload = () => {
      document.getElementById('app-title').innerText = isCloud ? "Aritm Cloud" : "Aritm Local";
      Storage.loadSettings(s => {
        if (!s) return;
        document.getElementById('total-problems').value = s.total;
        s.types.forEach(t => { const el = document.querySelector(`input[value="${t.val}"]`); if(el) el.checked = t.checked; });
      });
      Storage.loadProgress(p => {
        if (p && p.pool) { problemPool = p.pool; currentProblemStr = p.current; showView('game-view'); updateUI(); }
      });
    };

    function startSession() {
      const types = Array.from(document.querySelectorAll('input:checked')).map(i => ({val: i.value, checked: true}));
      Storage.saveSettings({total: document.getElementById('total-problems').value, types});
      // (Här skulle createPool-funktionen ligga, samma som tidigare...)
      problemPool = ["2 + 2", "5 ⋅ 5"]; // Exempel för demo
      nextProblem();
      showView('game-view');
    }

    function nextProblem() {
      if (problemPool.length === 0) { Storage.clearProgress(); showView('finish-view'); return; }
      currentProblemStr = problemPool.shift();
      Storage.saveProgress({pool: problemPool, current: currentProblemStr});
      updateUI();
    }

    function submitAnswer() {
      const val = document.getElementById('answer-input').value;
      const correct = eval(currentProblemStr.replace('⋅', '*'));
      if (parseInt(val) === correct) {
        document.getElementById('feedback').innerHTML = '<span class="correct">Rätt!</span>';
        setTimeout(() => { document.getElementById('feedback').innerText = ""; nextProblem(); }, 400);
      } else {
        playError();
        problemPool.push(currentProblemStr);
        Storage.saveProgress({pool: problemPool, current: currentProblemStr});
        document.getElementById('answer-input').value = "";
        updateUI();
      }
    }

    function quitGame() { document.getElementById('btn-continue').style.display = 'block'; showView('finish-view'); }
    function restartApp() { Storage.clearProgress(); showView('setup-view'); }
    function updateUI() { 
      document.getElementById('problem-text').innerText = currentProblemStr; 
      document.getElementById('count-left').innerText = "Kvar: " + (problemPool.length + 1);
      document.getElementById('answer-input').value = "";
    }
    function showView(v) { ['setup-view', 'game-view', 'finish-view'].forEach(id => document.getElementById(id).style.display = 'none'); document.getElementById(v).style.display = 'flex'; }
    function pressKey(n) { if(n==='C') document.getElementById('answer-input').value = ""; else document.getElementById('answer-input').value += n; }
  </script>
</body>
</html>
