<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <title>Aritm Cloud</title> 
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="color-scheme" content="light dark">
  <style>
    :root {
      --bg: #f0f2f5; --container-bg: #ffffff; --text: #333333;
      --accent: #1a73e8; --border: #dddddd; --status-bg: #ffffff;
      --key-bg: #ffffff; --key-text: #000000; --input-bg: #ffffff;
    }
    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #121212; --container-bg: #1e1e1e; --text: #e0e0e0;
        --accent: #4dabf7; --border: #333333; --status-bg: #1e1e1e;
        --key-bg: #2d2d2d; --key-text: #ffffff; --input-bg: #2d2d2d;
      }
    }
    * { -webkit-tap-highlight-color: transparent; user-select: none; box-sizing: border-box; }
    :focus { outline: none; }
    html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; background-color: var(--bg); color: var(--text); font-family: -apple-system, sans-serif; position: fixed; width: 100%; }
    #setup-view, #game-view, #finish-view, #quit-confirm-view { display: none; flex-direction: column; height: 100%; width: 100%; }
    .container { padding: 10px; display: flex; flex-direction: column; gap: 6px; flex-grow: 1; overflow-y: auto; }
    .status-bar { display: flex; justify-content: space-between; align-items: center; background: var(--status-bg); border-bottom: 1px solid var(--border); height: 35px; flex-shrink: 0; font-weight: bold; }
    .type-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; }
    .type-option { background: var(--container-bg); padding: 12px; border-radius: 8px; border: 1px solid var(--border); display: flex; align-items: center; font-weight: bold; cursor: pointer; }
    .type-option input { margin-right: 10px; transform: scale(1.2); }
    .adjust-container { display: flex; align-items: center; justify-content: center; background: var(--container-bg); border-radius: 8px; border: 1px solid var(--border); padding: 4px; }
    #total-problems { width: 70px; text-align: center; font-size: 20px; border: none; background: transparent; color: var(--text); font-weight: bold; }
    .adjust-btn { background: var(--accent); color: white; width: 45px; height: 35px; border-radius: 6px; font-size: 20px; border: none; cursor: pointer; }
    #problem-display { flex-grow: 1; display: flex; align-items: center; justify-content: center; font-size: clamp(40px, 10vh, 70px); font-weight: bold; color: var(--accent); }
    #answer-input { width: 80%; margin: 0 auto 10px; font-size: 32px; text-align: center; padding: 8px; border: 2px solid var(--accent); border-radius: 8px; background: var(--input-bg); color: var(--text); min-height: 55px; }
    .keypad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1px; background: var(--border); padding-bottom: env(safe-area-inset-bottom); }
    .key { background: var(--key-bg); color: var(--key-text); padding: 20px 0; font-size: 26px; font-weight: bold; text-align: center; cursor: pointer; }
    .btn-start { background: var(--accent); color: white; border: none; padding: 15px; border-radius: 8px; font-size: 18px; font-weight: bold; width: 100%; margin-top: 10px; }
    #about-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; display: none; align-items: center; justify-content: center; padding: 20px; }
    .about-content { background: var(--container-bg); padding: 20px; border-radius: 12px; width: 100%; max-width: 500px; }
    .discrete-link { margin-top: 15px; text-align: center; font-size: 14px; opacity: 0.7; cursor: pointer; text-decoration: underline; }
  </style>
</head>
<body data-current-view="setup-view">

  <div id="setup-view" style="display: flex;">
    <div class="container">
      <h2 style="text-align:center; color:var(--accent);">Aritm Cloud</h2>
      <div class="type-grid" id="type-options">
        <label class="type-option"><input type="checkbox" value="add1" checked> Add 1</label>
        <label class="type-option"><input type="checkbox" value="add2"> Add 2</label>
        <label class="type-option"><input type="checkbox" value="sub1"> Sub 1</label>
        <label class="type-option"><input type="checkbox" value="sub2"> Sub 2</label>
        <label class="type-option"><input type="checkbox" value="mul"> Mul</label>
        <label class="type-option"><input type="checkbox" value="div"> Div</label>
      </div>
      <div class="adjust-container">
        <button class="adjust-btn" onclick="adjustTotal(-5)">-</button>
        <input type="number" id="total-problems" value="20" readonly>
        <button class="adjust-btn" onclick="adjustTotal(5)">+</button>
      </div>
      <button class="btn-start" onclick="startSession()">STARTA TRÄNING</button>
      <div class="discrete-link" onclick="toggleAbout(true)">Om Aritm Cloud</div>
    </div>
  </div>

  <div id="game-view">
    <div class="status-bar">
      <span style="color:#dc3545; cursor:pointer;" onclick="confirmQuit()">&nbsp;&nbsp;Avbryt</span>
      <span id="count-left"></span>
    </div>
    <div id="problem-display"><span id="problem-text"></span></div>
    <input type="text" id="answer-input" readonly placeholder="?">
    <div id="feedback" style="text-align:center; height:30px; font-weight:bold;"></div>
    <div class="keypad">
      <div class="key" onclick="pressKey('7')">7</div><div class="key" onclick="pressKey('8')">8</div><div class="key" onclick="pressKey('9')">9</div>
      <div class="key" onclick="pressKey('4')">4</div><div class="key" onclick="pressKey('5')">5</div><div class="key" onclick="pressKey('6')">6</div>
      <div class="key" onclick="pressKey('1')">1</div><div class="key" onclick="pressKey('2')">2</div><div class="key" onclick="pressKey('3')">3</div>
      <div class="key" style="grid-column: span 2;" onclick="pressKey('0')">0</div><div class="key" style="color:#dc3545;" onclick="pressKey('C')">C</div>
      <div class="key btn-start" style="grid-column: span 3; margin:0; border-radius:0;" onclick="submitAnswer()">SVAR</div>
    </div>
  </div>

  <div id="about-modal">
    <div class="about-content">
      <h3>Om Aritm Cloud</h3>
      <p>Copyright © 2026 Mikael O. Bonnier, Lund, Sweden.</p>
      <p>Programvara under GNU GPL v3.</p>
      <button class="btn-start" onclick="toggleAbout(false)">Stäng</button>
    </div>
  </div>

  <div id="quit-confirm-view">
    <div class="container" style="text-align:center; justify-content:center;">
      <h2>Avbryta?</h2>
      <button class="btn-start" style="background:#dc3545;" onclick="quitGame()">JA, AVSLUTA</button>
      <button class="btn-start" style="background:var(--border); color:var(--text);" onclick="resumeGame()">NEJ</button>
    </div>
  </div>

  <script>
    const Storage = {
      isCloud: () => (typeof google !== 'undefined' && google.script && google.script.run),
      saveSettings: (s) => {
        const str = JSON.stringify(s);
        localStorage.setItem('aritm_settings', str);
        if (Storage.isCloud()) google.script.run.saveSettings(str);
      },
      saveProgress: (p) => {
        const str = JSON.stringify(p);
        localStorage.setItem('aritm_save', str);
        if (Storage.isCloud() && str.length < 8000) google.script.run.saveState(str);
      },
      clearProgress: () => {
        localStorage.removeItem('aritm_save');
        if (Storage.isCloud()) google.script.run.clearState();
      }
    };

    let problemPool = [], currentProblemStr = null, startTime = 0, initialTotal = 0;

    function showView(v) {
      ['setup-view', 'game-view', 'quit-confirm-view'].forEach(id => {
        document.getElementById(id).style.display = (id === v) ? 'flex' : 'none';
      });
    }

    function toggleAbout(show) { document.getElementById('about-modal').style.display = show ? 'flex' : 'none'; }

    function createPool(types) {
      let pool = [];
      types.forEach(t => {
        if (t === 'add1') { for(let i=0;i<10;i++) for(let j=0;j<10;j++) pool.push(`${i} + ${j}`); }
        else if (t === 'add2') { for(let i=0;i<10;i++) for(let j=0;j<10;j++) pool.push(`${10+i} + ${j}`); }
        else if (t === 'sub1') { for(let i=0;i<10;i++) for(let j=0;j<10;j++) pool.push(`${i+j} - ${j}`); }
        else if (t === 'sub2') { for(let i=0;i<10;i++) for(let j=0;j<10;j++) pool.push(`${10+i+j} - ${j}`); }
        else if (t === 'mul') { for(let i=0;i<10;i++) for(let j=0;j<10;j++) pool.push(`${i} ⋅ ${j}`); }
        else if (t === 'div') { for(let i=0;i<10;i++) for(let j=1;j<10;j++) pool.push(`${i*j} / ${j}`); }
      });
      return pool.sort(() => Math.random() - 0.5);
    }

    function startSession() {
      const selected = Array.from(document.querySelectorAll('#type-options input:checked')).map(i => i.value);
      if (!selected.length) return;
      const total = parseInt(document.getElementById('total-problems').value);
      Storage.saveSettings({total: total, types: selected});
      problemPool = createPool(selected);
      if (total > 0) problemPool = problemPool.slice(0, total);
      startTime = Date.now(); initialTotal = problemPool.length;
      showView('game-view'); nextProblem();
    }

    function nextProblem() {
      if (!problemPool.length) { 
        alert("Klar!"); Storage.clearProgress(); showView('setup-view'); return; 
      }
      currentProblemStr = problemPool.shift();
      document.getElementById('problem-text').innerText = currentProblemStr;
      document.getElementById('count-left').innerText = "Kvar: " + (problemPool.length + 1) + "  ";
      document.getElementById('answer-input').value = "";
      Storage.saveProgress({pool: problemPool, current: currentProblemStr, startTime, initialTotal});
    }

    function submitAnswer() {
      const val = document.getElementById('answer-input').value;
      if (!val) return;
      const expected = eval(currentProblemStr.replace('⋅', '*').replace('/', '/'));
      if (parseInt(val) === Math.floor(expected)) {
        nextProblem();
      } else {
        document.getElementById('feedback').innerText = "Fel!";
        setTimeout(() => document.getElementById('feedback').innerText = "", 800);
        problemPool.push(currentProblemStr);
        nextProblem();
      }
    }

    function pressKey(n) {
      const inp = document.getElementById('answer-input');
      if (n === 'C') inp.value = ""; else if (inp.value.length < 5) inp.value += n;
    }

    function adjustTotal(n) {
      const el = document.getElementById('total-problems');
      el.value = Math.max(0, parseInt(el.value) + n);
    }

    function confirmQuit() { showView('quit-confirm-view'); }
    function resumeGame() { showView('game-view'); }
    function quitGame() { Storage.clearProgress(); showView('setup-view'); }

    window.onload = () => {
      const s = JSON.parse(localStorage.getItem('aritm_settings'));
      if (s) {
        document.getElementById('total-problems').value = s.total;
        s.types.forEach(t => { 
          const cb = document.querySelector(`input[value="${t}"]`);
          if (cb) cb.checked = true;
        });
      }
      const p = JSON.parse(localStorage.getItem('aritm_save'));
      if (p) {
        problemPool = p.pool; currentProblemStr = p.current; startTime = p.startTime; initialTotal = p.initialTotal;
        document.getElementById('problem-text').innerText = currentProblemStr;
        showView('game-view');
      }
    };
  </script>
</body>
</html>
