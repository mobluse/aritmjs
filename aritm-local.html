<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <title>Aritm Local</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#f0f2f5">
  
  <style>
    /* --- CSS (Samma som förut, optimerad) --- */
    html, body { 
      height: 100%; margin: 0; padding: 0; 
      overflow: hidden; background-color: #f0f2f5;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      position: fixed; width: 100%; top: 0; left: 0;
      user-select: none; -webkit-user-select: none;
    }

    body { display: flex; flex-direction: column; }

    #setup-view, #game-view, #finish-view { 
      display: none; flex-direction: column; height: 100%; width: 100%; 
      box-sizing: border-box;
    }

    /* STATUSRAD */
    .status-bar {
      display: flex; justify-content: space-between; align-items: center;
      padding: 10px 15px; background: white; border-bottom: 1px solid #ddd;
      font-weight: bold; font-size: 16px; flex-shrink: 0; height: 44px; box-sizing: border-box;
    }
    #btn-quit-text { color: #dc3545; cursor: pointer; }
    #count-left { color: #555; }

    /* SETUP VIEW */
    .container { padding: 15px; display: flex; flex-direction: column; gap: 8px; flex-grow: 1; overflow-y: auto; }
    h2 { color: #1a73e8; text-align: center; margin: 5px 0; font-size: 20px; }
    .type-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .type-option { 
      background: white; padding: 10px; border-radius: 8px; border: 1px solid #ddd;
      display: flex; align-items: center; font-weight: bold; font-size: 14px; cursor: pointer;
    }
    .type-option input { margin-right: 10px; transform: scale(1.2); }
    
    .quick-select-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; }
    .quick-btn { 
      background: white; border: 1.5px solid #1a73e8; color: #1a73e8; 
      padding: 8px 0; text-align: center; border-radius: 6px; font-weight: bold; font-size: 14px; cursor: pointer;
    }
    .adjust-container { display: flex; align-items: center; justify-content: center; background: white; padding: 5px; border-radius: 8px; border: 1px solid #ddd; }
    #total-problems { width: 60px; text-align: center; font-size: 20px; font-weight: bold; border: none; background: transparent; }
    .adjust-btn { background: #e8f0fe; color: #1a73e8; width: 45px; height: 35px; display: flex; align-items: center; justify-content: center; border-radius: 6px; font-size: 20px; font-weight: bold; cursor: pointer; }
    .btn-start { background: #1a73e8; color: white; border: none; padding: 12px; border-radius: 8px; font-size: 18px; font-weight: bold; margin-top: 5px; cursor: pointer; }

    /* GAME VIEW */
    #problem-display { 
      flex-grow: 1; display: flex; align-items: center; justify-content: center; 
      font-size: clamp(40px, 10vh, 60px); font-weight: bold; color: #1a73e8; 
    }

    #answer-input { 
      width: 70%; margin: 0 auto 5px; font-size: 32px; text-align: center; 
      padding: 5px; border: 2px solid #1a73e8; border-radius: 8px; 
      background: white; pointer-events: none; flex-shrink: 0; color: #000;
    }

    /* FEEDBACK */
    #feedback { 
      text-align: center; height: 24px; min-height: 24px;
      font-weight: bold; font-size: 18px; margin-bottom: 5px; 
      display: flex; align-items: center; justify-content: center; flex-shrink: 0;
    }
    .checking { color: #f1c40f !important; }
    .correct { color: #28a745 !important; }
    .wrong { color: #dc3545 !important; }

    /* KEYPAD */
    .keypad { 
      display: grid; grid-template-columns: repeat(3, 1fr); gap: 1px; 
      background: #ccc; width: 100%; flex-shrink: 0; 
      padding-bottom: env(safe-area-inset-bottom);
    }
    .key { 
      background: white; padding: clamp(10px, 2vh, 18px) 0; 
      font-size: 24px; font-weight: bold; text-align: center; 
      cursor: pointer; touch-action: manipulation; 
    }
    .key:active { background: #e0e0e0; }
    .key-0 { grid-column: span 2; }
    .key-clear { color: #dc3545; }
    .key-enter { background: #1a73e8; color: white; grid-column: span 3; font-size: 20px; padding: 12px 0; }

    /* GPL Länk */
    .gpl-link { margin-top: 20px; text-align: center; }
    .gpl-link a { font-size: 10px; color: #999; text-decoration: none; }
  </style>
</head>
<body>

  <div id="setup-view">
    <div class="container">
      <h2>Inställningar</h2>
      <div class="type-grid">
        <label class="type-option"><input type="checkbox" value="add1" checked> Add 1</label>
        <label class="type-option"><input type="checkbox" value="add2"> Add 2</label>
        <label class="type-option"><input type="checkbox" value="sub1"> Sub 1</label>
        <label class="type-option"><input type="checkbox" value="sub2"> Sub 2</label>
        <label class="type-option"><input type="checkbox" value="mult"> Mult</label>
        <label class="type-option"><input type="checkbox" value="div"> Div</label>
      </div>
      
      <div style="margin-top: 5px; width: 100%;">
        <label style="font-size: 14px; font-weight: bold; color: #666;">Antal:</label>
        <div class="quick-select-grid">
          <div class="quick-btn" onclick="setTotal(10)">10</div>
          <div class="quick-btn" onclick="setTotal(20)">20</div>
          <div class="quick-btn" onclick="setTotal(50)">50</div>
          <div class="quick-btn" onclick="setTotal(0)">Alla</div>
        </div>
        <div class="adjust-container" style="margin-top: 6px;">
          <div class="adjust-btn" onclick="adjustTotal(-5)">-</div>
          <input type="number" id="total-problems" value="20" readonly>
          <div class="adjust-btn" onclick="adjustTotal(5)">+</div>
        </div>
      </div>
      <button class="btn-start" onclick="startSession()">STARTA</button>
      
      <div class="gpl-link">
         <a href="https://www.gnu.org/licenses/gpl-3.0.html" target="_blank">Licensierad under GPLv3</a>
      </div>
    </div>
  </div>

  <div id="game-view">
    <div class="status-bar">
      <span id="btn-quit-text" onclick="quitGame()">Avbryt</span>
      <span id="count-left">Kvar: -</span>
    </div>
    <div id="problem-display"><span id="problem-text"></span></div>
    <input type="text" id="answer-input" readonly placeholder="?">
    <div id="feedback"></div>
    <div class="keypad">
      <div class="key" onclick="pressKey('7')">7</div>
      <div class="key" onclick="pressKey('8')">8</div>
      <div class="key" onclick="pressKey('9')">9</div>
      <div class="key" onclick="pressKey('4')">4</div>
      <div class="key" onclick="pressKey('5')">5</div>
      <div class="key" onclick="pressKey('6')">6</div>
      <div class="key" onclick="pressKey('1')">1</div>
      <div class="key" onclick="pressKey('2')">2</div>
      <div class="key" onclick="pressKey('3')">3</div>
      <div class="key key-0" onclick="pressKey('0')">0</div>
      <div class="key key-clear" onclick="pressKey('C')">C</div>
      <div class="key key-enter" onclick="submitAnswer()">SVAR</div>
    </div>
  </div>

  <div id="finish-view">
    <div class="container" style="text-align: center; justify-content: center;">
      <h2 id="finish-title">Klar!</h2>
      <p id="final-score" style="font-size: 18px; color: #555;"></p>
      <button class="btn-start" onclick="restartApp()">NY ÖVNING</button>
    </div>
  </div>

  <script>
    /* --- LOGIK (Ersätter Code.gs) --- */
    
    let currentState = null;
    let isProcessing = false;

    // Ljudhantering
    const errorAudio = new Audio('https://www.soundjay.com/buttons/beep-10.mp3');
    errorAudio.preload = 'auto';

    function unlockAudio() {
      errorAudio.play().then(() => {
        errorAudio.pause(); errorAudio.currentTime = 0;
      }).catch(e => {});
      window.removeEventListener('touchstart', unlockAudio);
      window.removeEventListener('click', unlockAudio);
    }
    window.addEventListener('touchstart', unlockAudio, false);
    window.addEventListener('click', unlockAudio, false);

    // Viewport-fix för iOS
    function fixViewport() {
      window.scrollTo(0, 0);
      setTimeout(() => {
        document.body.style.height = window.innerHeight + 'px';
        window.scrollTo(0, 0);
      }, 100); 
    }
    window.addEventListener('resize', fixViewport);
    window.addEventListener('orientationchange', () => setTimeout(fixViewport, 200));

    // INITIERING: Ladda state från LocalStorage
    window.onload = function() {
      fixViewport();
      const savedState = localStorage.getItem('aritmState');
      if (savedState) {
        currentState = JSON.parse(savedState);
        showView('game-view');
        updateUI();
      } else {
        showView('setup-view');
      }
    };

    // GENERERA PROBLEM (Flyttat från Code.gs)
    function generateProblem(types) {
      const type = types[Math.floor(Math.random() * types.length)];
      let num1, num2, answer, str;

      switch(type) {
        case 'add1': // Enkelt: 0-10 + 0-10
          num1 = Math.floor(Math.random() * 11);
          num2 = Math.floor(Math.random() * 11);
          answer = num1 + num2;
          str = `${num1} + ${num2}`;
          break;
        case 'add2': // Svårare: Upp till summa 100
          num1 = Math.floor(Math.random() * 40) + 10;
          num2 = Math.floor(Math.random() * 40) + 10;
          answer = num1 + num2;
          str = `${num1} + ${num2}`;
          break;
        case 'sub1': // Enkelt: 0-20 minus något
          num1 = Math.floor(Math.random() * 20) + 1;
          num2 = Math.floor(Math.random() * (num1 + 1));
          answer = num1 - num2;
          str = `${num1} - ${num2}`;
          break;
        case 'sub2': // Svårare diff
          num1 = Math.floor(Math.random() * 80) + 20;
          num2 = Math.floor(Math.random() * (num1 - 10)) + 5;
          answer = num1 - num2;
          str = `${num1} - ${num2}`;
          break;
        case 'mult': // Tabeller 0-10
          num1 = Math.floor(Math.random() * 10) + 1;
          num2 = Math.floor(Math.random() * 11);
          answer = num1 * num2;
          str = `${num1} ⋅ ${num2}`;
          break;
        case 'div': // Division utan rest
          num2 = Math.floor(Math.random() * 9) + 2; 
          answer = Math.floor(Math.random() * 10) + 1;
          num1 = num2 * answer;
          str = `${num1} / ${num2}`;
          break;
        default: // Fallback
          num1 = 1; num2 = 1; answer = 2; str = "1 + 1";
      }
      return { num1, num2, answer, str, type };
    }

    // SPEL-MOTOR
    function startSession() {
      const types = Array.from(document.querySelectorAll('.type-option input:checked')).map(e => e.value);
      if (types.length === 0) return;
      
      let total = parseInt(document.getElementById('total-problems').value) || 20;
      if (total === 0) total = 9999; // "Alla" = oändligt läge egentligen

      currentState = {
        types: types,
        problemsLeft: total,
        currentProblem: generateProblem(types),
        totalStart: total
      };
      
      saveState();
      showView('game-view');
      updateUI();
    }

    function submitAnswer() {
      if (isProcessing || !currentState) return;
      const inputVal = document.getElementById('answer-input').value;
      if (!inputVal) return;

      const userAns = parseInt(inputVal);
      const correctAns = currentState.currentProblem.answer;

      isProcessing = true;
      const f = document.getElementById('feedback');
      f.innerText = "Rättar...";
      f.style.color = ""; f.className = "checking";

      // Simulera nätverksfördröjning (känns bättre)
      setTimeout(() => {
        checkAnswer(userAns, correctAns);
      }, 50); // Mycket snabbare än GAS
    }

    function checkAnswer(userAns, correctAns) {
      const f = document.getElementById('feedback');
      
      if (userAns === correctAns) {
        // RÄTT
        f.innerText = "Rätt!";
        f.className = "correct";
        currentState.problemsLeft--;
        
        if (currentState.problemsLeft <= 0) {
          finishGame();
        } else {
          // Nytt problem
          currentState.currentProblem = generateProblem(currentState.types);
          saveState();
          setTimeout(() => {
            f.innerText = ""; f.className = "";
            updateUI();
            isProcessing = false;
          }, 400);
        }
      } else {
        // FEL
        f.innerText = "Fel! Försök igen.";
        f.className = "wrong";
        
        // Straff: Lägg till uppgift (om ej "alla" läge)
        if (currentState.totalStart < 9000) {
          currentState.problemsLeft++; 
        }
        
        saveState();
        document.getElementById('count-left').innerText = "Kvar: " + currentState.problemsLeft;
        
        if (errorAudio) {
          errorAudio.currentTime = 0;
          errorAudio.play().catch(e => {});
        }
        if (navigator.vibrate) navigator.vibrate(200);
        
        document.getElementById('answer-input').value = "";
        isProcessing = false;
      }
    }

    function finishGame() {
      currentState = null;
      localStorage.removeItem('aritmState'); // Rensa sparad session
      showView('finish-view');
      document.getElementById('final-score').innerText = "Bra jobbat! Sessionen är klar.";
      isProcessing = false;
    }

    function quitGame() {
      if (currentState) {
        const left = currentState.problemsLeft;
        currentState = null;
        localStorage.removeItem('aritmState');
        showView('finish-view');
        document.getElementById('finish-title').innerText = "Avbruten";
        document.getElementById('final-score').innerText = "Du hade " + left + " kvar.";
      } else {
         showView('setup-view');
      }
    }

    // UI HELPER FUNCTIONS
    function saveState() {
      localStorage.setItem('aritmState', JSON.stringify(currentState));
    }

    function updateUI() {
      if (!currentState) return;
      document.getElementById('problem-text').innerText = currentState.currentProblem.str;
      document.getElementById('count-left').innerText = "Kvar: " + currentState.problemsLeft;
      document.getElementById('answer-input').value = "";
      fixViewport();
    }

    function restartApp() {
      currentState = null;
      localStorage.removeItem('aritmState');
      showView('setup-view');
    }

    function showView(v) {
      document.getElementById('setup-view').style.display = 'none';
      document.getElementById('game-view').style.display = 'none';
      document.getElementById('finish-view').style.display = 'none';
      document.getElementById(v).style.display = 'flex';
      
      const f = document.getElementById('feedback');
      f.innerText = ""; f.className = "";
      fixViewport();
    }

    // Keypad Logic
    function setTotal(n) { document.getElementById('total-problems').value = n; }
    function adjustTotal(d) {
      let v = parseInt(document.getElementById('total-problems').value) || 0;
      v = Math.max(0, v + d);
      document.getElementById('total-problems').value = v;
    }
    function pressKey(n) {
      if (isProcessing) return;
      const i = document.getElementById('answer-input');
      if (n === 'C') i.value = "";
      else if (i.value.length < 5) i.value += n;
    }
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') { quitGame(); }
      else if (e.key >= '0' && e.key <= '9') { pressKey(e.key); } 
      else if (e.key === 'Enter') { submitAnswer(); } 
      else if (e.key === 'Backspace') { pressKey('C'); }
    });
  </script>
</body>
</html>
